---
name: verification-before-completion
description: Use before completing any task or change. This skill enforces a comprehensive verification checklist to ensure quality, completeness, and correctness before marking work as done.
---

# Verification Before Completion 技能

## 目标

> 当前阶段该技能暂不启用，默认不在 `/repo-apply` 流程中执行。

在标记任务完成前，强制执行全面的验证清单，确保质量、完整性和正确性。

**核心铁律**：没有验证，不算完成。

---

## 验证层次

```
┌─────────────────────────────────────────────────────────────┐
│                    完成前验证（门禁）                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  功能验证    │  │  质量验证    │  │  规范验证    │        │
│  │  (Function) │  │  (Quality)  │  │  (Spec)     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         ↓                ↓                ↓                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  集成验证    │  │  文档验证    │  │  部署验证    │        │
│  │ (Integration)│  │ (Docs)      │  │ (Deploy)    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 六维度验证框架

### 维度 1: 功能验证（Function Verification）

**目标**：确认功能按预期工作

#### 检查清单

**基本功能**：
- [ ] 核心功能正常工作
- [ ] 边界条件正确处理
- [ ] 错误情况正确处理
- [ ] 用户输入有效验证

**测试验证**：
```bash
# 运行所有测试
npm test

# 检查测试覆盖率
npm run test:coverage

# 最低覆盖率要求
# - 语句覆盖率 ≥ 80%
# - 分支覆盖率 ≥ 75%
# - 函数覆盖率 ≥ 80%
# - 行覆盖率 ≥ 80%
```

**手动验证**：
- [ ] 正常路径测试通过
- [ ] 异常路径测试通过
- [ ] 边界值测试通过

#### 验证记录

```markdown
## 功能验证

### 自动化测试
```bash
npm test
```
**结果**：
```
Test Suites: 5 passed, 5 total
Tests:       42 passed, 42 total
Coverage:    85% (statements), 82% (branches)
```
**状态**：✅ 通过

### 手动测试
| 场景 | 测试步骤 | 预期结果 | 实际结果 | 状态 |
|------|----------|----------|----------|------|
| 正常验证码 | 输入正确验证码 | 验证成功 | 验证成功 | ✅ |
| 错误验证码 | 输入错误验证码 | 验证失败 | 验证失败 | ✅ |
| 过期验证码 | 输入过期验证码 | 验证失败 | 验证失败 | ✅ |
| 空验证码 | 输入空字符串 | 抛出错误 | 抛出错误 | ✅ |
```

---

### 维度 2: 质量验证（Quality Verification）

**目标**：确认代码质量达标

#### 检查清单

**代码规范**：
```bash
# 运行 Lint
npm run lint

# 运行类型检查
npm run type-check

# 运行格式检查
npm run format:check
```

**代码质量指标**：
- [ ] 无 ESLint 错误
- [ ] 无 TypeScript 错误
- [ ] 代码符合 Prettier 格式
- [ ] 无 console.log/TODO/FIXME
- [ ] 无魔法数字/硬编码值

**代码审查要点**：
- [ ] 命名清晰（驼峰命名，语义化）
- [ ] 函数单一职责
- [ ] 注释适当（不过度，不少量）
- [ ] 错误处理完整
- [ ] 无重复代码

#### 验证记录

```markdown
## 质量验证

### 代码规范检查
```bash
npm run lint
```
**结果**：
```
✅ No linting errors
✅ All files formatted
```

### 类型检查
```bash
npm run type-check
```
**结果**：
```
✅ No TypeScript errors
```

### 代码审查
| 项目 | 状态 | 备注 |
|------|------|------|
| 命名规范 | ✅ | 使用语义化命名 |
| 单一职责 | ✅ | 每个函数职责明确 |
| 注释适当 | ✅ | 复杂逻辑有注释 |
| 错误处理 | ✅ | 所有异常已处理 |
| 无重复代码 | ✅ | 提取了公共函数 |
```

---

### 维度 3: 规范验证（Spec Verification）

**目标**：确认实现符合设计规范

#### 检查清单

**设计文档对比**：
- [ ] 实现与 `design.md` 一致
- [ ] API 端点符合设计
- [ ] 数据模型符合设计
- [ ] 行为符合预期

**任务完成度**：
- [ ] 所有 `tasks.md` 任务已完成
- [ ] 没有遗漏的功能
- [ ] 没有额外的功能（范围蔓延）

#### 验证记录

```markdown
## 规范验证

### 设计文档对比
| 设计项 | 设计要求 | 实际实现 | 符合性 |
|--------|----------|----------|--------|
| API 端点 | POST /api/auth/verify-email | ✅ 已实现 | 符合 |
| 数据模型 | email_verification_tokens 表 | ✅ 已创建 | 符合 |
| 验证逻辑 | bcrypt 哈希比较 | ✅ 已实现 | 符合 |
| 过期时间 | 5 分钟 | ✅ 已实现 | 符合 |

### 任务完成度
**总任务数**：15
**已完成**：15
**完成率**：100%

**状态**：✅ 所有任务已完成
```

---

### 维度 4: 集成验证（Integration Verification）

**目标**：确认与现有系统集成良好

#### 检查清单

**依赖检查**：
- [ ] 新增依赖已添加到 package.json
- [ ] 依赖版本兼容
- [ ] 无安全漏洞

**集成点检查**：
- [ ] 与现有服务集成正常
- [ ] API 调用无错误
- [ ] 数据库操作正常
- [ ] 外部服务调用正常

**回归测试**：
```bash
# 运行完整测试套件
npm test

# 检查是否有破坏性变更
npm run test:regression
```

#### 验证记录

```markdown
## 集成验证

### 依赖检查
```bash
npm audit
```
**结果**：
```
✅ No vulnerabilities found
✅ All dependencies up to date
```

### 集成点测试
| 集成点 | 测试 | 结果 |
|--------|------|------|
| EmailService | 发送验证邮件 | ✅ 正常 |
| UserService | 创建用户 | ✅ 正常 |
| Database | 保存令牌 | ✅ 正常 |

### 回归测试
```bash
npm test
```
**结果**：
```
✅ All existing tests still pass
✅ No breaking changes detected
```
```

---

### 维度 5: 文档验证（Documentation Verification）

**目标**：确认文档完整准确

#### 检查清单

**代码文档**：
- [ ] 公共 API 有 JSDoc 注释
- [ ] 复杂逻辑有内联注释
- [ ] 参数和返回值有类型定义

**用户文档**：
- [ ] README 已更新（如需要）
- [ ] API 文档已更新（如需要）
- [ ] 变更日志已更新（如需要）

#### 验证记录

```markdown
## 文档验证

### 代码文档
| 文件 | JSDoc | 内联注释 | 状态 |
|------|-------|----------|------|
| EmailVerificationService.ts | ✅ | ✅ | 完整 |
| AuthController.ts | ✅ | ✅ | 完整 |
| types.ts | ✅ | ✅ | 完整 |

### 用户文档
- [ ] README.md - ✅ 已添加使用说明
- [ ] API.md - ✅ 已更新端点文档
- [ ] CHANGELOG.md - ✅ 已记录变更
```

---

### 维度 6: 部署验证（Deployment Verification）

**目标**：确认可以安全部署

#### 检查清单

**构建验证**：
```bash
# 构建项目
npm run build

# 验证构建产物
ls -la dist/
```

**配置验证**：
- [ ] 环境变量已配置
- [ ] 配置文件正确
- [ ] 敏感信息未泄露

**部署前检查**：
- [ ] 数据库迁移脚本准备就绪
- [ ] 回滚计划已准备
- [ ] 监控和告警已配置

#### 验证记录

```markdown
## 部署验证

### 构建验证
```bash
npm run build
```
**结果**：
```
✅ Build successful
✅ Output size: 2.3MB
✅ No build warnings
```

### 配置验证
- [ ] 环境变量：✅ 已配置
- [ ] 数据库连接：✅ 测试通过
- [ ] Redis 连接：✅ 测试通过

### 部署清单
- [ ] 数据库迁移：✅ script ready
- [ ] 回滚计划：✅ documented
- [ ] 监控告警：✅ configured
```

---

## 质量门标准

**所有验证项必须通过才能标记完成**。

### 通过标准

| 维度 | 通过标准 |
|------|----------|
| 功能 | 所有测试通过，手动测试通过 |
| 质量 | 0 Lint 错误，0 TS 错误 |
| 规范 | 100% 任务完成，符合设计 |
| 集成 | 0 回归失败，0 漏洞 |
| 文档 | 所有公共 API 有文档 |
| 部署 | 构建成功，配置正确 |

### 质量等级

```
🟢 绿色（通过）：所有验证通过 → 可以标记完成
🟡 黄色（警告）：非关键验证未通过 → 需要评估风险
🔴 红色（失败）：关键验证未通过 → 不能标记完成
```

---

## 验证报告模板

```markdown
# 完成前验证报告

**任务 ID**：1.1-1.5
**变更 ID**：email-verification
**验证时间**：YYYY-MM-DD HH:MM
**验证人**：Claude

---

## 验证总结

**总体状态**：🟢 通过

| 维度 | 状态 | 通过率 |
|------|------|--------|
| 功能 | 🟢 | 100% |
| 质量 | 🟢 | 100% |
| 规范 | 🟢 | 100% |
| 集成 | 🟢 | 100% |
| 文档 | 🟢 | 100% |
| 部署 | 🟢 | 100% |

---

## 详细验证结果

### 1. 功能验证
[详细验证内容]

### 2. 质量验证
[详细验证内容]

### 3. 规范验证
[详细验证内容]

### 4. 集成验证
[详细验证内容]

### 5. 文档验证
[详细验证内容]

### 6. 部署验证
[详细验证内容]

---

## 遗留问题

**无**

---

## 证据收集

**测试报告**：[链接或附件]
**代码审查**：[链接或附件]
**构建日志**：[链接或附件]

---

## 最终结论

✅ **所有验证通过，可以标记完成。**

**下一步**：归档变更
```

---

## 快速验证模式

**对于小任务（< 30 分钟）**，可以使用快速验证：

```markdown
## 快速验证清单

- [ ] 测试通过（npm test）
- [ ] Lint 通过（npm run lint）
- [ ] 类型检查通过（npm run type-check）
- [ ] 手动测试通过
- [ ] 代码审查通过
- [ ] 文档已更新

**状态**：✅ 快速验证通过
```

---

## MCP 工具使用

**本技能使用的 MCP 工具**：

- [x] `Bash` - 运行测试、Lint、构建
- [x] `Read` - 阅读代码和文档
- [x] `Grep` - 搜索代码模式
- [x] `Glob` - 查找文件

---

## 禁止行为

- ❌ 跳过验证步骤
- ❌ 忽略验证失败
- ❌ 降低质量标准
- ❌ 缺少证据收集
- ❌ 伪造验证结果

---

## 完成标志

当以下条件满足时，本技能完成：

- [x] 所有六维度验证已完成
- [x] 所有验证项通过
- [x] 验证报告已生成
- [x] 证据已收集
- [x] 用户确认验证结果

---

## 与其他技能的集成

**后置技能**：当前阶段默认不启用，需要时手动调用

**集成流程（可选）**：
```
任何执行技能 → verification-before-completion → 标记完成
     ↓                     ↓                      ↓
  完成工作              全面验证                质量保证
```

**触发方式**：
- 手动调用（用户明确要求完整验证时）
